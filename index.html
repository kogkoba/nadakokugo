<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>灘選抜【国語】簡易勉強システム</title>
<style>
  body{font-family:sans-serif;background:#0b1020;color:#fff;margin:0}
  .wrap{max-width:900px;margin:auto;padding:20px}
  button{margin:4px;padding:8px 12px;font-weight:bold;border:none;border-radius:6px;cursor:pointer}
  button.primary{background:#4fc3f7;color:#000}
  button.ghost{background:transparent;border:1px solid #999;color:#fff}
  .flash{background:#121a33;padding:20px;border-radius:12px;margin-top:16px}

   /* 問題や答えを少し小さく表示 */
  .q{
    white-space:pre-line;
    font-size:0.95rem;   /* ← 1.2rem → 0.95rem に変更 */
    line-height:1.35;    /* 行間を少し詰める */
  }
  .a{
    margin-top:8px;
    color:#ccc;
    display:none;
    font-size:0.9rem;    /* 答え表示も小さめに */
    line-height:1.35;
  }
  .msg{
    font-size:0.9rem;    /* 判定メッセージも小さく統一 */
    line-height:1.3;
  }
  .msg.ok{color:#3ddc97}
  .msg.ng{color:#ff6b6b}


  /* 【追加】カウンター枠のスタイル */
  .counter{
    margin:12px 0 8px;
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    border:1px solid rgba(255,255,255,.2); border-radius:10px; padding:10px 12px;
    background:rgba(255,255,255,.06);
  }
  .counter .pill{
    display:inline-block; padding:4px 10px; border-radius:999px;
    background:#0c1328; border:1px solid rgba(255,255,255,.2);
    font-weight:700;
  }

  /* 【見えなくなる問題】IME変換候補やモバイルKBが被らないための余白仕組み */
  :root{ --kb-safe: max(env(safe-area-inset-bottom, 0px), 0px); }
  body.kb-open { padding-bottom: calc( var(--kb-space, 240px) + var(--kb-safe) ); }
  .ime-spacer{ display:none; height:var(--kb-space, 240px); }
  body.kb-open .ime-spacer{ display:block; }

  /* 【固定入力欄】カード下部に入力エリアを固定する */
  #flashcard{ position:relative; }
  .qa-scroll{
    /* 入力欄の上下動を防ぐため、質問/選択肢はここをスクロール */
    max-height: min(48vh, 520px);
    overflow:auto;
    padding-bottom:8px;
  }
  .answer-dock{
    position: sticky;
    bottom: calc(16px + var(--kb-safe)); /* 画面下からの固定位置 */
    z-index: 2;
    margin: 10px -20px -20px;           /* カード端まで広げる */
    padding: 12px 20px 16px;
    background: rgba(11,16,32,.85);     /* 背景を半透明にして下の内容と分離 */
    backdrop-filter: blur(6px);
    border-top: 1px solid rgba(255,255,255,.12);
    border-bottom-left-radius: 12px;
    border-bottom-right-radius: 12px;
  }
  .answer-dock input{
    width:100%;
    padding:8px;
    border-radius:6px;
    border:1px solid #999;
    background:#0c1328;
    color:#fff;
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>灘選抜【国語】簡易勉強システム</h1>

  <p style="color:#bbb;margin:8px 0 12px">
    ①「初期登録」：<code>problems</code> シートの全問題を <code>log</code> に登録（重複はスキップ）<br>
    ② 出題：<b>未正解のみ</b> または <b>全件</b> を選択<br>
    回答すると <code>log</code> の <code>isCorrect</code> が更新されます
  </p>

  <div style="margin:8px 0">
    <button id="initBtn" class="primary">① problems → log に初期登録</button>
    <button id="loadUnanswered" class="ghost">② 未正解のみ出題</button>
    <button id="loadAll" class="ghost">② 全件出題</button>
  </div>

  <!-- カウンター -->
  <div class="counter" id="counterBox">
    <span>カウンター：</span>
    <span class="pill">正解数 <span id="okCount">0</span></span>
    <span class="pill">おこづかい <span id="allowance">0</span> 円（1正解=1円）</span>
    <button id="resetCounterBtn" class="ghost">カウンターをリセット</button>
  </div>

  <div id="flashcard" class="flash" style="display:none">
    <!-- 【固定入力欄】上側：スクロール領域（質問＆選択肢） -->
    <div class="qa-scroll">
      <div id="frontText" class="q"></div>
      <div id="backText" class="a"></div>
      <div id="message" class="msg" style="margin-top:6px"></div>
    </div>

    <!-- 【固定入力欄】下側：常にほぼ同じ位置にある入力ドック -->
    <div class="answer-dock">
      <input id="answerInput" type="text" placeholder="答えを入力">
      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
        <button id="submitBtn" class="primary">判定（Enter）</button>
        <button id="revealBtn" class="ghost">答え表示（/）</button>
        <button id="prevBtn" class="ghost">◀ 前（P）</button>
        <button id="nextBtn" class="ghost">次 ▶（N）</button>
      </div>
    </div>
  </div>

  <!-- 【見えなくなる問題】IME候補やKBで隠れないようにする余白ブロック -->
  <div id="belowSpace" class="ime-spacer" aria-hidden="true"></div>
</div>

<script>
// === あなたのGAS WebアプリURL（exec） ===
const GAS_URL = "https://script.google.com/macros/s/AKfycbya0ARmIZ9XTPdNjaw3UZ57oLuFRdufGdm5rbJFjZMnPO9i7YdCDUfHCzYQ5yNaysDr/exec";

// ひらがな正規化
function toHiragana(str){return str.replace(/[ァ-ン]/g,s=>String.fromCharCode(s.charCodeAt(0)-0x60));}
function normalize(s){
  return toHiragana((s||'').toLowerCase().normalize('NFKC')
    .replace(/[\s\u3000]/g,'')
    .replace(/[、。・，．,.!?！？:：;；~〜ー―\-_/\\()\[\]【】<>＜＞]/g,''));
}

let deck=[], idx=0;
let judged = false; // 直近の問題が判定済みか

// 正解カウンター（1正解=1円）
const ALLOWANCE_PER_OK = 1;
let okTotal = Number(localStorage.getItem('okTotal') || 0);
const okCountEl = document.getElementById('okCount');
const allowanceEl = document.getElementById('allowance');
function updateCounterUI(){
  okCountEl.textContent = okTotal;
  allowanceEl.textContent = okTotal * ALLOWANCE_PER_OK;
  localStorage.setItem('okTotal', String(okTotal));
}
updateCounterUI();
document.getElementById('resetCounterBtn').onclick = ()=>{
  if(confirm('正解カウンターを0にリセットしますか？')){
    okTotal = 0; updateCounterUI();
  }
};

/* 初期登録：problems -> log */
document.getElementById('initBtn').onclick = async ()=>{
  try{
    const res = await fetch(GAS_URL + '?mode=problems');
    if(!res.ok) throw new Error('problems取得に失敗: ' + res.status);
    const list = await res.json();
    if(!Array.isArray(list) || !list.length) throw new Error('problems が空です（front/back を確認）');
    const post = await fetch(GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action: 'init', list })
    });
    if(!post.ok) throw new Error('log初期登録に失敗: ' + post.status);
    alert(`logに登録しました（${list.length}件、重複はスキップ）`);
  }catch(err){ console.error(err); alert(err.message||'初期登録でエラー'); }
};

/* log から読み込み */
async function loadFromLog(mode){
  try{
    const res = await fetch(GAS_URL + '?mode=' + encodeURIComponent(mode));
    if(!res.ok) throw new Error('log取得に失敗: ' + res.status);
    const arr = await res.json();
    if(!Array.isArray(arr) || !arr.length){ alert('出題できる問題が見つかりません'); return; }
    // シャッフル
    for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    deck = arr; idx = 0; render();
  }catch(err){ console.error(err); alert(err.message||'読み込みでエラー'); }
}
document.getElementById('loadUnanswered').onclick=()=>loadFromLog('unanswered');
document.getElementById('loadAll').onclick=()=>loadFromLog('all');

/* 表示 */
function render(){
  if(!deck.length){ document.getElementById('flashcard').style.display='none'; return; }
  const c=deck[idx];

  // 表示領域更新（質問＆選択肢）
  document.getElementById('frontText').textContent = c.front || '';
  const ans=c.back||'';
  const backEl=document.getElementById('backText');
  if(/<\w+/.test(ans)) backEl.innerHTML=ans; else backEl.textContent=ans;
  backEl.style.display='none';

  // 入力欄リセット（位置は固定なので揺れない）
  const msg=document.getElementById('message'); msg.textContent=''; msg.className='msg';
  const input = document.getElementById('answerInput');
  input.value='';
  document.getElementById('flashcard').style.display='block';
  judged = false;
  input.focus();
}

function next(){ if(deck.length){ idx=(idx+1)%deck.length; render(); } }
function prev(){ if(deck.length){ idx=(idx-1+deck.length)%deck.length; render(); } }
function reveal(){ const b=document.getElementById('backText'); b.style.display=b.style.display==='none'?'block':'none'; }

/* 判定 → log更新 → カウンター加算 */
async function checkAnswer(){
  if(!deck.length) return;
  const c = deck[idx];
  const userRaw = document.getElementById('answerInput').value;
  const user = normalize(userRaw);
  const answers = String(c.back||'').split('|').map(s=>normalize(s));
  const ok = answers.includes(user);

  const msg=document.getElementById('message');
  msg.textContent = ok ? '正解！' : ('不正解。正解は: ' + String(c.back||'').split('|')[0]);
  msg.className = ok ? 'msg ok' : 'msg ng';

  judged = true;

  if(ok){ okTotal += 1; updateCounterUI(); }

  try{
    fetch(GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({
        action: 'update',
        question: String(c.front || ''),
        correctAnswer: String(c.back || '').split('|')[0],
        isCorrect: ok
      })
    }).catch(err => console.error(err));
  }catch(err){ console.error(err); }
}

/* クリック設定 */
document.getElementById('submitBtn').onclick = checkAnswer;
document.getElementById('revealBtn').onclick = reveal;
document.getElementById('nextBtn').onclick = next;
document.getElementById('prevBtn').onclick = prev;

/* ショートカット */
window.addEventListener('keydown',(e)=>{
  if (e.isComposing) return;
  const tag = (document.activeElement?.tagName || '').toLowerCase();
  const isTyping = tag === 'input' || tag === 'textarea' || document.activeElement?.isContentEditable;

  if(e.key==='/' ){ e.preventDefault(); reveal(); }
  if(e.key.toLowerCase()==='n'){
    e.preventDefault();
    if(judged) next(); else checkAnswer();
  }
  if(e.key.toLowerCase()==='p'){ e.preventDefault(); prev(); }

  if(e.key==='Enter' && isTyping){
    e.preventDefault();
    if(e.shiftKey || e.ctrlKey){ checkAnswer(); next(); }
    else{ checkAnswer(); }
  }
  if(e.key==='Enter' && !isTyping){
    e.preventDefault();
    if(judged) next(); else checkAnswer();
  }
});

/* 【見えなくなる問題】IME候補で隠れないようにする処理 */
const answerEl = document.getElementById('answerInput');
const spacerEl = document.getElementById('belowSpace');

function estimateKbSpace(){
  let h = 240;
  if (window.visualViewport){
    const diff = window.innerHeight - window.visualViewport.height;
    if (diff > 120) h = Math.min(Math.max(diff, 200), 360);
  }
  document.documentElement.style.setProperty('--kb-space', h + 'px');
}
function openKbSpace(){
  estimateKbSpace();
  document.body.classList.add('kb-open');
  // 入力欄を視界に保つ
  setTimeout(()=>{ document.querySelector('.answer-dock').scrollIntoView({block:'end',behavior:'smooth'}); }, 50);
}
function closeKbSpace(){
  document.body.classList.remove('kb-open');
}
answerEl.addEventListener('focus', openKbSpace);
answerEl.addEventListener('blur', closeKbSpace);
if (window.visualViewport){
  window.visualViewport.addEventListener('resize', ()=>{
    const likelyOpen = window.visualViewport.height < window.innerHeight - 50;
    if (document.activeElement === answerEl && likelyOpen){ openKbSpace(); }
    else{ closeKbSpace(); }
  });
}
</script>
</body>
</html>
