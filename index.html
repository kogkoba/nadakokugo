<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>国語フラッシュカード（log連携版）</title>
<style>
  body{font-family:sans-serif;background:#0b1020;color:#fff;margin:0}
  .wrap{max-width:900px;margin:auto;padding:20px}
  button{margin:4px;padding:8px 12px;font-weight:bold;border:none;border-radius:6px;cursor:pointer}
  button.primary{background:#4fc3f7;color:#000}
  button.ghost{background:transparent;border:1px solid #999;color:#fff}
  input[type=text]{width:100%;padding:8px;border-radius:4px;border:1px solid #999}
  .flash{background:#121a33;padding:20px;border-radius:8px;margin-top:16px}
  .q{white-space:pre-line;font-size:1.2rem}
  .a{margin-top:10px;color:#ccc;display:none}
  .msg.ok{color:#4caf50}
  .msg.ng{color:#ff5252}
</style>
</head>
<body>
<div class="wrap">
  <h1>国語フラッシュカード（log連携版）</h1>

  <div>
    <label>問題用CSV公開URL</label>
    <input id="csvUrl" type="text" placeholder="https://docs.google.com/spreadsheets/d/.../output=csv">
  </div>

  <div style="margin-top:8px">
    <button id="initBtn" class="primary">CSVをlogに登録</button>
    <button id="loadUnanswered" class="ghost">未正解のみ出題</button>
    <button id="loadAll" class="ghost">全件出題</button>
  </div>

  <div id="flashcard" class="flash" style="display:none">
    <div id="frontText" class="q"></div>
    <div id="backText" class="a"></div>
    <input id="answerInput" type="text" placeholder="答えを入力">
    <div id="message" class="msg"></div>
    <div style="margin-top:8px">
      <button id="submitBtn" class="primary">判定（Enter）</button>
      <button id="revealBtn" class="ghost">答え表示（/）</button>
      <button id="prevBtn" class="ghost">◀ 前（P）</button>
      <button id="nextBtn" class="ghost">次 ▶（N）</button>
    </div>
  </div>
</div>

<script>
// --- 固定GAS URL（こぐれさんのURLを埋め込み） ---
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwzZe8VUC7meDMKx8BtMXB8Q58az9xmW-mhNptPu8xKTiQzBlNOkUUtLQPnJTyvxUJo/exec";

  
// --- CSVパーサ（Googleスプレッドシート対応） ---
function parseCSV(text){
  text = text.replace(/^\uFEFF/,'').replace(/\r\n/g,'\n');
  const rows=[]; let cur='', row=[], inQuotes=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(inQuotes){
      if(c==='"' && n==='"'){cur+='"'; i++;}
      else if(c==='"'){inQuotes=false;}
      else{cur+=c;}
    }else{
      if(c==='"'){inQuotes=true;}
      else if(c===','){row.push(cur); cur='';}
      else if(c==='\n'){row.push(cur); rows.push(row); row=[]; cur='';}
      else{cur+=c;}
    }
  }
  row.push(cur); rows.push(row);
  if(rows.length===0){ return []; }
  const header=rows.shift().map(h=>(h||'').trim());
  return rows
    .filter(r=>r.some(v=>(v||'').trim()!==''))
    .map(r=>Object.fromEntries(header.map((h,i)=>[h, r[i]??''])));
}

// --- 正規化（ひらがな化＋記号/空白除去） ---
function toHiragana(str){return str.replace(/[ァ-ン]/g,s=>String.fromCharCode(s.charCodeAt(0)-0x60));}
function normalize(s){
  return toHiragana((s||'').toLowerCase().normalize('NFKC')
    .replace(/[\s\u3000]/g,'')
    .replace(/[、。・，．,.!?！？:：;；~〜ー―\-_/\\()\[\]【】<>＜＞]/g,''));
}

let deck=[], idx=0;

// --- CSVをlogに登録 ---
document.getElementById('initBtn').onclick = async ()=>{
  try{
    const csvUrl = document.getElementById('csvUrl').value.trim();
    if(!csvUrl) return alert('CSVの公開URLを入力してください');

    const res = await fetch(csvUrl);
    if(!res.ok){ throw new Error('CSV取得に失敗: ' + res.status); }
    const text = await res.text();

    if(/^\s*</.test(text)){
      throw new Error('CSVではなくHTMLが返りました。公開設定（対象シート・CSV）とURLを確認してください。');
    }

    const rows = parseCSV(text);
    if(!rows.length){ throw new Error('CSVにデータがありません'); }

    // front/back 列のみを使用。無い行は除外
    const list = rows.map(r=>({
      question: (r.front??'').toString(),
      correctAnswer: (r.back??'').toString()
    })).filter(x => x.question);

    if(!list.length){
      throw new Error('CSVに front / back 列が見つからないか、空です。');
    }

    const post = await fetch(GAS_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({action:'init', list})
    });
    if(!post.ok){ throw new Error('GAS(init)エラー: ' + post.status); }

    alert(`logに登録しました（${list.length}件、重複はスキップ）`);
  }catch(err){
    console.error(err);
    alert(err.message||'初期登録でエラーが発生しました');
  }
};

// --- logから読み込み（未正解/全件） ---
async function loadFromLog(mode){
  try{
    const res = await fetch(GAS_URL + '?mode=' + encodeURIComponent(mode));
    if(!res.ok){ throw new Error('log取得に失敗: ' + res.status); }
    const arr = await res.json();
    if(!Array.isArray(arr) || arr.length===0){
      alert('出題できる問題が見つかりません'); return;
    }
    // シャッフル
    for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    deck = arr; idx = 0; render();
  }catch(err){
    console.error(err);
    alert(err.message||'読み込みでエラーが発生しました');
  }
}
document.getElementById('loadUnanswered').onclick=()=>loadFromLog('unanswered');
document.getElementById('loadAll').onclick=()=>loadFromLog('all');

// --- 画面描画 ---
function render(){
  if(!deck.length){ document.getElementById('flashcard').style.display='none'; return; }
  const c=deck[idx];
  document.getElementById('frontText').textContent = c.front||'';
  const ans = c.back||'';
  if(/<\w+/.test(ans)){ document.getElementById('backText').innerHTML=ans; }
  else{ document.getElementById('backText').textContent=ans; }
  document.getElementById('backText').style.display='none';
  document.getElementById('answerInput').value='';
  document.getElementById('message').textContent='';
  document.getElementById('message').className='msg';
  document.getElementById('flashcard').style.display='block';
}
function next(){ if(deck.length){ idx=(idx+1)%deck.length; render(); } }
function prev(){ if(deck.length){ idx=(idx-1+deck.length)%deck.length; render(); } }
function reveal(){ const b=document.getElementById('backText'); b.style.display=b.style.display==='none'?'block':'none'; }

// --- 判定 → GASに結果更新 ---
async function checkAnswer(){
  if(!deck.length) return;
  const c = deck[idx];
  const raw = document.getElementById('answerInput').value;
  const user = normalize(raw);
  const corrects = String(c.back||'').split('|').map(s=>normalize(s));
  const ok = corrects.includes(user);

  document.getElementById('message').textContent = ok ? '正解！' : ('不正解。正解は: ' + String(c.back||'').split('|')[0]);
  document.getElementById('message').className = ok ? 'msg ok' : 'msg ng';

  try{
    const post = await fetch(GAS_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({action:'update', question:String(c.front||''), correctAnswer:String(c.back||'').split('|')[0], isCorrect:ok})
    });
    if(!post.ok){ console.error('GAS(update)エラー: ' + post.status); }
  }catch(err){ console.error(err); }

  setTimeout(()=>{ next(); }, ok?600:900);
}

document.getElementById('submitBtn').onclick=checkAnswer;
document.getElementById('revealBtn').onclick=reveal;
document.getElementById('nextBtn').onclick=next;
document.getElementById('prevBtn').onclick=prev;

// --- ショートカット ---
window.addEventListener('keydown',(e)=>{
  if(e.key==='/' ){ e.preventDefault(); reveal(); }
  if(e.key.toLowerCase()==='n'){ e.preventDefault(); next(); }
  if(e.key.toLowerCase()==='p'){ e.preventDefault(); prev(); }
  if(e.key==='Enter' && !e.shiftKey && !e.ctrlKey){ e.preventDefault(); checkAnswer(); }
  if(e.key==='Enter' && (e.shiftKey||e.ctrlKey)){ e.preventDefault(); checkAnswer(); idx=(idx+1)%deck.length; render(); }
});
</script>
</body>
</html>
