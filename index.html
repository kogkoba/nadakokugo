<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>国語フラッシュカード（学習ログ＋初出題管理/GAS連携）</title>
<style>
  :root{--bg:#0b1020;--card:#121a33;--text:#e8eefc;--muted:#9fb2d8;--accent:#67b4ff;--ok:#3ddc97;--ng:#ff6b6b}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;background:#0b1020;color:var(--text);margin:0}
  .wrap{max-width:980px;margin:auto;padding:20px}
  h1{margin:8px 0 16px}
  .panel{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:14px}
  .grid{display:grid;gap:10px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  label{display:block;font-size:.9rem;color:var(--muted);margin-bottom:4px}
  input[type=text]{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0c1328;color:var(--text)}
  button{appearance:none;border:none;background:var(--accent);color:#001229;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,.18);color:var(--text)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .hint{color:var(--muted);font-size:.85rem}
  .flash{margin-top:14px;background:#121a33;border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:22px;min-height:220px;position:relative}
  .q{font-size:1.15rem;white-space:pre-line;line-height:1.7}
  .a{margin-top:10px;display:none;color:#cfe3ff}
  .badge{position:absolute;top:10px;right:12px;color:var(--muted);font-size:.85rem}
  .answer-box{display:flex;gap:8px;margin-top:12px}
  .answer-box input{flex:1}
  .msg{margin-top:8px;font-weight:700}
  .msg.ok{color:var(--ok)}
  .msg.ng{color:var(--ng)}
  .stats{display:flex;gap:12px;margin-top:8px;color:var(--muted);font-size:.9rem}
</style>
</head>
<body>
<div class="wrap">
  <h1>国語フラッシュカード（記述式・ランダム出題）</h1>

  <div class="panel grid">
    <div>
      <label>Googleスプレッドシートの <strong>CSV公開URL</strong></label>
      <input id="csvUrl" type="text" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vTetYp32lIacrC0HlJlWY-JPeyuDrv660zeNkHPY8gGoaOUDnE_qFhe1pFZV9JVfp8yrAxhnxxu2fGF/pub?gid=0&single=true&output=csv" placeholder="https://docs.google.com/spreadsheets/d/【ID】/export?format=csv&id=【ID】&gid=【gid】" />
      <div class="hint">※ スプレッドシート → ファイル ＞ ウェブに公開 → 形式 <strong>CSV</strong> のURLを貼付け</div>
    </div>
    <div class="grid cols-2">
      <div>
        <label>問題の列名</label>
        <input id="frontKey" type="text" value="front" />
      </div>
      <div>
        <label>答えの列名（複数は | 区切り）</label>
        <input id="backKey" type="text" value="back" />
      </div>
    </div>
    <div class="grid cols-2">
      <div>
        <label>https://script.google.com/macros/s/AKfycbyq3ZNA3PHgcLzeiU0JyNfhTIIibgbCHKryIySmzpuP6MrfoDIqTwU4dBfp0VuSE2KS/exec</label>
        <input id="logUrl" type="text" placeholder="https://script.google.com/macros/s/…/exec" />
        <div class="hint">※ 設定すると「読み込んだ全問題（初出題）」と「各解答の正誤」を <strong>自動記録</strong> します</div>
      </div>
      <div>
        <label>記録オプション</label>
        <div class="row">
          <label class="row"><input id="logInitOnLoad" type="checkbox" checked> 初回読み込みを記録（初出題）</label>
          <label class="row"><input id="logAttempts" type="checkbox" checked> 解答の正誤を記録</label>
        </div>
      </div>
    </div>

    <div class="row">
      <button id="loadBtn">CSVから読み込む（初出題を記録）</button>
      <button class="ghost" id="demoBtn">デモデータ</button>
      <button class="ghost" id="loadMissedOrNewBtn">ログ（GAS）から <strong>間違い＋初出題</strong> を読む</button>
      <button class="ghost" id="loadAllLogBtn">ログ（GAS）から <strong>全問題</strong> を読む</button>
      <label class="row" style="gap:6px"><input id="excludeSeen" type="checkbox"> 正解した問題をデッキから除外</label>
    </div>
    <div class="hint">ショートカット：Enter＝判定／<strong>Shift+Enter or Ctrl+Enter＝判定して次へ</strong>／N＝次へ／P＝前へ／←→＝移動／<code>/</code>＝答え表示</div>
  </div>

  <div class="row" style="margin-top:10px">
    <button id="prevBtn" class="ghost">◀ 前へ（P）</button>
    <button id="revealBtn">答えを表示（/）</button>
    <button id="nextBtn" class="ghost">次へ ▶（N）</button>
    <button id="shuffleBtn" class="ghost">ランダム並べ替え</button>
    <button id="resetBtn" class="ghost">進捗リセット</button>
    <button id="mistBtn" class="ghost">（この回の）間違いのみ</button>
    <button id="allBtn" class="ghost">全件に戻す</button>
  </div>

  <div id="flashcard" class="flash" style="display:none">
    <div class="badge" id="badge">0 / 0</div>
    <div class="q" id="frontText"></div>
    <div class="a" id="backText"></div>
    <div class="answer-box">
      <input id="answerInput" type="text" placeholder="答えを入力（例：だす）" autocomplete="off" />
      <button id="submitBtn">送信（Enter）</button>
    </div>
    <div class="msg" id="message"></div>
  </div>

  <div class="stats" id="stats" style="display:none">
    <div>総数: <span id="statTotal">0</span></div>
    <div>既出: <span id="statSeen">0</span></div>
    <div>正解: <span id="statOk">0</span></div>
    <div>不正解: <span id="statNg">0</span></div>
    <div>正答率: <span id="statRate">0%</span></div>
  </div>
</div>

<script>
// ===== CSVパーサ（Googleスプレッドシート対応） =====
function parseCSV(text){
  text = text.replace(/^\uFEFF/, '').replace(/\r\n/g, '\n');
  const rows = []; let cur = '', row = [], inQuotes = false;
  for (let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(inQuotes){
      if(c=='"' && n=='"'){ cur+='"'; i++; }
      else if(c=='"'){ inQuotes=false; }
      else cur+=c;
    }else{
      if(c=='"'){ inQuotes=true; }
      else if(c==','){ row.push(cur); cur=''; }
      else if(c=='\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
      else cur+=c;
    }
  }
  row.push(cur); rows.push(row);
  if(!rows.length) return [];
  const header = rows.shift().map(h=>(h||'').trim());
  return rows
    .filter(r => r.some(v => (v||'').trim()!==''))
    .map(r => { const o={}; header.forEach((h,i)=>o[h]=r[i]??''); return o; });
}

// ===== 日本語判定の正規化 =====
function toHiragana(str){ return str.replace(/[ァ-ン]/g, s => String.fromCharCode(s.charCodeAt(0)-0x60)); }
function normalize(s){
  return toHiragana((s||'').toLowerCase().normalize('NFKC')
    .replace(/[\s\u3000]/g,'')
    .replace(/[、。・，．,.!?！？:：;；~〜ー―\-_/\\\(\)\[\]【】<>＜＞]/g,''));
}

// ===== 状態 =====
let cardsAll=[], deck=[], idx=0;
let frontKey='front', backKey='back';
let okCount=0, ngCount=0; const seen=new Set();

// ===== 要素 =====
const $=id=>document.getElementById(id);
const csvUrl=$('csvUrl'), loadBtn=$('loadBtn'), demoBtn=$('demoBtn');
const frontInp=$('frontKey'), backInp=$('backKey');
const flash=$('flashcard'), frontTxt=$('frontText'), backTxt=$('backText');
const badge=$('badge'), statBox=$('stats');
const statTotal=$('statTotal'), statSeen=$('statSeen'), statOk=$('statOk'), statNg=$('statNg'), statRate=$('statRate');
const prevBtn=$('prevBtn'), nextBtn=$('nextBtn'), revealBtn=$('revealBtn');
const shuffleBtn=$('shuffleBtn'), resetBtn=$('resetBtn'), mistBtn=$('mistBtn'), allBtn=$('allBtn');
const input=$('answerInput'), submitBtn=$('submitBtn'), msg=$('message');
const excludeSeen=$('excludeSeen');
const logUrl=$('logUrl'), logInitOnLoad=$('logInitOnLoad'), logAttempts=$('logAttempts');
const loadMissedOrNewBtn=$('loadMissedOrNewBtn'), loadAllLogBtn=$('loadAllLogBtn');

function updateStats(){
  statTotal.textContent=cardsAll.length; statSeen.textContent=seen.size; statOk.textContent=okCount; statNg.textContent=ngCount;
  const rate=(okCount+ngCount)? Math.round(okCount*100/(okCount+ngCount)) : 0; statRate.textContent=rate+'%';
}

function render(){
  if(deck.length===0){ flash.style.display='none'; statBox.style.display='none'; return; }
  const c=deck[idx];
  flash.style.display='block'; statBox.style.display='flex';
  frontTxt.textContent=c[frontKey]??'';
  const ans=c[backKey]??''; if(/<\w+/.test(ans)) backTxt.innerHTML=ans; else backTxt.textContent=ans; backTxt.style.display='none';
  input.value=''; input.focus(); msg.textContent=''; msg.className='msg';
  badge.textContent=`${idx+1} / ${deck.length}`; updateStats();
}
function next(){ if(deck.length){ idx=(idx+1)%deck.length; render(); } }
function prev(){ if(deck.length){ idx=(idx-1+deck.length)%deck.length; render(); } }
function reveal(){ backTxt.style.display = backTxt.style.display==='none' ? 'block' : 'none'; }
function shuffle(){ for(let i=deck.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [deck[i],deck[j]]=[deck[j],deck[i]]; } idx=0; render(); }
function resetProgress(){ seen.clear(); okCount=0; ngCount=0; cardsAll.forEach(c=>{c.__ok=0;c.__ng=0;c.__seen=false}); render(); }
function onlyMist(){ const m=cardsAll.filter(c=>c.__ng>0); if(m.length){ deck=m.slice(); idx=0; render(); } else alert('不正解カードはまだありません'); }
function useAll(){ deck=cardsAll.slice(); idx=0; render(); }

// ===== ログ連携 =====
function postJSON(url, payload){
  return fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
}
function logInitDeck(list){
  const url=(logUrl.value||'').trim(); if(!url || !logInitOnLoad.checked) return;
  // 1件ずつ送信（GASはシンプルなdoPostを想定）
  list.forEach((c,i)=>{
    postJSON(url,{type:'init',question:String(c[frontKey]||''),correctAnswer:String(c[backKey]||''),index:i+1,total:list.length,source:'nadakokugo'});
  });
}
async function fetchLog(mode){
  const url=(logUrl.value||'').trim();
  if(!url){ alert('GASのウェブアプリURLを設定してください'); return []; }
  const resp = await fetch(url + (url.includes('?')?'&':'?') + 'mode=' + mode);
  if(!resp.ok){ alert('ログの取得に失敗しました: '+resp.status); return []; }
  const arr = await resp.json();
  return Array.isArray(arr)? arr : [];
}

// ===== 判定 =====
function checkAnswer(){
  const userRaw=input.value; const user=normalize(userRaw);
  const c=deck[idx]; const answersRaw=String(c[backKey]||'');
  const answers=answersRaw.split('|').map(x=>normalize(x));
  const correct=answers.some(a=>a.length>0 && a===user);
  c.__seen=true; seen.add(c);

  if((logUrl.value||'').trim() && logAttempts.checked){
    postJSON(logUrl.value.trim(),{
      type:'attempt',
      question:String(c[frontKey]||''),
      userAnswer:userRaw,
      correctAnswer:answersRaw.split('|')[0]||'',
      isCorrect:correct,
      index:idx+1,
      total:deck.length,
      source:'nadakokugo'
    }).catch(()=>{});
  }

  if(correct){
    c.__ok=(c.__ok||0)+1; okCount++; msg.textContent='正解！'; msg.className='msg ok';
    if(excludeSeen.checked){ deck.splice(idx,1); if(idx>=deck.length) idx=0; }
    setTimeout(()=>{ render(); }, 600);
  } else {
    c.__ng=(c.__ng||0)+1; ngCount++; msg.textContent='不正解。正解は：'+answersRaw.split('|')[0]; msg.className='msg ng';
    setTimeout(()=>{ render(); }, 900);
  }
  updateStats(); input.focus();
}

// ===== データ読み込み =====
async function loadCSV(url){
  const res=await fetch(url); if(!res.ok) throw new Error('CSVの取得に失敗: '+res.status);
  const text=await res.text();
  if (/^\s*</.test(text)) throw new Error('CSVではなくHTMLが返りました。公開設定（「このシート」「CSV」）とURLを確認してください。');
  return parseCSV(text); // オブジェクト配列
}
function setDeck(list){
  cardsAll=list.map(x=>({...x,__ok:0,__ng:0,__seen:false}));
  deck=cardsAll.slice(); shuffle();
}

// ===== イベント =====
document.getElementById('loadBtn').addEventListener('click', async()=>{
  try{
    frontKey=frontInp.value.trim()||'front'; backKey=backInp.value.trim()||'back';
    const url=csvUrl.value.trim(); if(!url) return alert('CSVの公開URLを入力してください');
    const data=await loadCSV(url);
    const filtered=data.filter(r=>r[frontKey]!==undefined && r[backKey]!==undefined);
    if(!filtered.length){ alert(`列名『${frontKey}』『${backKey}』が見つかりません。`); return; }
    if((logUrl.value||'').trim()) logInitDeck(filtered); // ← 初出題を記録
    setDeck(filtered);
  }catch(e){ alert(e.message); }
});
document.getElementById('demoBtn').addEventListener('click',()=>{
  frontKey=frontInp.value.trim()||'front'; backKey=backInp.value.trim()||'back';
  const demo=[
    {[frontKey]:'Q,つぎの□に共通して入る語をひらがなで書きなさい。\n舌を□\nあごを□\n口を□',[backKey]:'だす'},
    {[frontKey]:'「雨が上がる」の反対の意味の言葉をひらがなで書きなさい。',[backKey]:'ふる|降る'},
    {[frontKey]:'「草木が生える」の反対の意味の言葉をひらがなで書きなさい。',[backKey]:'かれる|枯れる'}
  ]; if((logUrl.value||'').trim()) logInitDeck(demo); setDeck(demo);
});

loadMissedOrNewBtn.addEventListener('click', async()=>{
  const arr = await fetchLog('missed_or_unseen'); // ← 間違い＋初出題
  if(!arr.length){ alert('該当する問題が見つかりません。'); return; }
  setDeck(arr);
});
loadAllLogBtn.addEventListener('click', async()=>{
  const arr = await fetchLog('all'); // ← 全問題
  if(!arr.length){ alert('ログの取得結果が空でした。'); return; }
  setDeck(arr);
});

document.getElementById('prevBtn').addEventListener('click', prev);
document.getElementById('nextBtn').addEventListener('click', next);
document.getElementById('revealBtn').addEventListener('click', reveal);
document.getElementById('shuffleBtn').addEventListener('click', shuffle);
document.getElementById('resetBtn').addEventListener('click', resetProgress);
document.getElementById('mistBtn').addEventListener('click', onlyMist);
document.getElementById('allBtn').addEventListener('click', useAll);

document.getElementById('submitBtn').addEventListener('click', ()=>checkAnswer());
document.getElementById('answerInput').addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !e.shiftKey && !e.ctrlKey){ e.preventDefault(); checkAnswer(); }
  if(e.key==='Enter' && (e.shiftKey||e.ctrlKey)){ e.preventDefault(); checkAnswer(); setTimeout(next, 50); }
});

// 入力中でも N/P/矢印 等で移動できるようにする
window.addEventListener('keydown', (e)=>{
  const ae=document.activeElement; const tag=(ae&&ae.tagName?ae.tagName.toLowerCase():''); const isTyping=tag==='input'||tag==='textarea'||(ae&&ae.isContentEditable);
  if(e.key==='/' ){ e.preventDefault(); reveal(); return; }
  if(e.key.toLowerCase()==='n' && !e.ctrlKey && !e.metaKey && !e.altKey){ if(isTyping) e.preventDefault(); next(); return; }
  if(e.key.toLowerCase()==='p' && !e.ctrlKey && !e.metaKey && !e.altKey){ if(isTyping) e.preventDefault(); prev(); return; }
  if(e.key==='ArrowRight'){ if(isTyping) e.preventDefault(); next(); return; }
  if(e.key==='ArrowLeft' ){ if(isTyping) e.preventDefault(); prev(); return; }
});
</script>
</body>
</html>
