<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>灘選抜【国語】簡易勉強システム</title>
<style>
  body{font-family:sans-serif;background:#0b1020;color:#fff;margin:0}
  .wrap{max-width:900px;margin:auto;padding:20px}
  button{margin:4px;padding:8px 12px;font-weight:bold;border:none;border-radius:6px;cursor:pointer}
  button.primary{background:#4fc3f7;color:#000}
  button.ghost{background:transparent;border:1px solid #999;color:#fff}
  .flash{background:#121a33;padding:20px;border-radius:8px;margin-top:16px}
  .q{white-space:pre-line;font-size:1.2rem}
  .a{margin-top:10px;color:#ccc;display:none}
  .msg.ok{color:#3ddc97}
  .msg.ng{color:#ff6b6b}
</style>
</head>
<body>
<div class="wrap">
  <h1>灘選抜【国語】簡易勉強システム</h1>

  <p style="color:#bbb;margin:8px 0 12px">
    ①「初期登録」：<code>problems</code> シートの全問題を <code>log</code> に登録（重複はスキップ）<br>
    ② 出題：<b>未正解のみ</b> または <b>全件</b> を選択<br>
    回答すると <code>log</code> の <code>isCorrect</code> が更新されます
  </p>

  <div style="margin:8px 0">
    <button id="initBtn" class="primary">① problems → log に初期登録</button>
    <button id="loadUnanswered" class="ghost">② 未正解のみ出題</button>
    <button id="loadAll" class="ghost">② 全件出題</button>
  </div>

  <div id="flashcard" class="flash" style="display:none">
    <div id="frontText" class="q"></div>
    <div id="backText" class="a"></div>

    <div style="margin-top:10px">
      <input id="answerInput" type="text" placeholder="答えを入力（ひらがな）" style="width:100%;padding:8px;border-radius:6px;border:1px solid #999;background:#0c1328;color:#fff">
      <div id="message" class="msg"></div>
      <div style="margin-top:8px">
        <button id="submitBtn" class="primary">判定（Enter）</button>
        <button id="revealBtn" class="ghost">答え表示（/）</button>
        <button id="prevBtn" class="ghost">◀ 前（P）</button>
        <button id="nextBtn" class="ghost">次 ▶（N）</button>
      </div>
    </div>
  </div>
</div>

<script>
// === あなたのGAS WebアプリURL（exec） ===
const GAS_URL = "https://script.google.com/macros/s/AKfycbya0ARmIZ9XTPdNjaw3UZ57oLuFRdufGdm5rbJFjZMnPO9i7YdCDUfHCzYQ5yNaysDr/exec";

// ひらがな正規化
function toHiragana(str){return str.replace(/[ァ-ン]/g,s=>String.fromCharCode(s.charCodeAt(0)-0x60));}
function normalize(s){
  return toHiragana((s||'').toLowerCase().normalize('NFKC')
    .replace(/[\s\u3000]/g,'')
    .replace(/[、。・，．,.!?！？:：;；~〜ー―\-_/\\()\[\]【】<>＜＞]/g,''));
}

let deck=[], idx=0;
let judged = false; // 【追加】直近の問題が判定済みかどうかのフラグ
  
// 初期登録：problems -> log
document.getElementById('initBtn').onclick = async ()=>{
  try{
    const res = await fetch(GAS_URL + '?mode=problems');
    if(!res.ok) throw new Error('problems取得に失敗: ' + res.status);
    const list = await res.json();
    if(!Array.isArray(list) || !list.length) throw new Error('problems が空です（front/back を確認）');

    // ★ CORS preflight回避のため Content-Type は text/plain を使用
    const post = await fetch(GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action: 'init', list })
    });
    if(!post.ok) throw new Error('log初期登録に失敗: ' + post.status);

    alert(`logに登録しました（${list.length}件、重複はスキップ）`);
  }catch(err){ console.error(err); alert(err.message||'初期登録でエラー'); }
};

// log から読み込み
async function loadFromLog(mode){
  try{
    const res = await fetch(GAS_URL + '?mode=' + encodeURIComponent(mode));
    if(!res.ok) throw new Error('log取得に失敗: ' + res.status);
    const arr = await res.json();
    if(!Array.isArray(arr) || !arr.length){ alert('出題できる問題が見つかりません'); return; }
    // シャッフル
    for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    deck = arr; idx = 0; render();
  }catch(err){ console.error(err); alert(err.message||'読み込みでエラー'); }
}
document.getElementById('loadUnanswered').onclick=()=>loadFromLog('unanswered');
document.getElementById('loadAll').onclick=()=>loadFromLog('all');

// 表示
function render(){
  if(!deck.length){ document.getElementById('flashcard').style.display='none'; return; }
  const c=deck[idx];
  document.getElementById('frontText').textContent = c.front || '';
  const ans=c.back||'';
  const backEl=document.getElementById('backText');
  if(/<\w+/.test(ans)) backEl.innerHTML=ans; else backEl.textContent=ans;
  backEl.style.display='none';
  document.getElementById('answerInput').value='';
  const msg=document.getElementById('message'); msg.textContent=''; msg.className='msg';
  document.getElementById('flashcard').style.display='block';

  judged = false; // 【追加】新しい問題に切り替わったら判定状態をリセット
  document.getElementById('answerInput').focus(); // 【追加】最初は入力欄にフォーカス
}
  
function next(){ if(deck.length){ idx=(idx+1)%deck.length; render(); } }
function prev(){ if(deck.length){ idx=(idx-1+deck.length)%deck.length; render(); } }
function reveal(){ const b=document.getElementById('backText'); b.style.display=b.style.display==='none'?'block':'none'; }

// 判定→log更新
async function checkAnswer(){
  if(!deck.length) return;
  const c = deck[idx];
  const userRaw = document.getElementById('answerInput').value;
  const user = normalize(userRaw);
  const answers = String(c.back||'').split('|').map(s=>normalize(s));
  const ok = answers.includes(user);

  const msg=document.getElementById('message');
  msg.textContent = ok ? '正解！' : ('不正解。正解は: ' + String(c.back||'').split('|')[0]);
  msg.className = ok ? 'msg ok' : 'msg ng';

  try{
    await fetch(GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // preflight回避
      body: JSON.stringify({
        action: 'update',
        question: String(c.front || ''),
        correctAnswer: String(c.back || '').split('|')[0],
        isCorrect: ok
      })
    });
  }catch(err){
    console.error(err);
  }
 judged = true; // 【追加】判定済みにする
 document.getElementById('answerInput').blur(); // 【追加】入力欄からフォーカスを外す
}
// --- イベント登録 ---
document.getElementById('submitBtn').onclick = checkAnswer;
document.getElementById('revealBtn').onclick = reveal;
document.getElementById('nextBtn').onclick = next;
document.getElementById('prevBtn').onclick = prev;

// --- ショートカット ---
window.addEventListener('keydown',(e)=>{
  const tag = (document.activeElement?.tagName || '').toLowerCase();
  const isTyping = tag === 'input' || tag === 'textarea' || document.activeElement?.isContentEditable;

  if(e.key==='/' ){ e.preventDefault(); reveal(); }
  if(e.key.toLowerCase()==='n'){ 
    e.preventDefault();
    if(judged) next(); else checkAnswer(); // 【追加】判定前なら判定、判定後なら次へ
  }
  if(e.key.toLowerCase()==='p'){ e.preventDefault(); prev(); }

  if(e.key==='Enter' && isTyping){
    e.preventDefault();
    if(e.shiftKey || e.ctrlKey){
      checkAnswer(); next(); // 【追加】Shift/Ctrl+Enter = 判定して次へ
    }else{
      checkAnswer(); // Enter = 判定のみ
    }
  }
  if(e.key==='Enter' && !isTyping){
    e.preventDefault();
    if(judged) next(); else checkAnswer(); // 【追加】入力欄外でも同様の動作
  }
});
</script>
</body>
</html>
