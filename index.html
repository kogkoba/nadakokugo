<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>国語フラッシュカード（log連携版）</title>
<style>
body{font-family:sans-serif;background:#0b1020;color:#fff;margin:0}
.wrap{max-width:900px;margin:auto;padding:20px}
button{margin:4px;padding:8px 12px;font-weight:bold;border:none;border-radius:6px;cursor:pointer}
button.primary{background:#4fc3f7;color:#000}
button.ghost{background:transparent;border:1px solid #999;color:#fff}
input[type=text]{width:100%;padding:8px;border-radius:4px;border:1px solid #999}
.flash{background:#121a33;padding:20px;border-radius:8px;margin-top:16px}
.q{white-space:pre-line;font-size:1.2rem}
.a{margin-top:10px;color:#ccc;display:none}
.msg.ok{color:#4caf50}
.msg.ng{color:#ff5252}
</style>
</head>
<body>
<div class="wrap">
<h1>国語フラッシュカード（log連携版）</h1>

<div>
<label>問題用CSV公開URL</label>
<input id="csvUrl" type="text" placeholder="https://docs.google.com/spreadsheets/d/.../output=csv">
</div>

<div style="margin-top:8px">
<button id="initBtn" class="primary">CSVをlogに登録</button>
<button id="loadUnanswered" class="ghost">未正解のみ出題</button>
<button id="loadAll" class="ghost">全件出題</button>
</div>

<div id="flashcard" class="flash" style="display:none">
<div id="frontText" class="q"></div>
<div id="backText" class="a"></div>
<input id="answerInput" type="text" placeholder="答えを入力">
<div id="message" class="msg"></div>
<div style="margin-top:8px">
<button id="submitBtn" class="primary">判定（Enter）</button>
<button id="revealBtn" class="ghost">答え表示（/）</button>
<button id="prevBtn" class="ghost">◀ 前（P）</button>
<button id="nextBtn" class="ghost">次 ▶（N）</button>
</div>
</div>
</div>

<script>
// 固定GAS URL
const GAS_URL = "https://script.google.com/macros/s/AKfycbzyeUq0KF7Kym9-JmoPCPkRz2t_GFJU2YjZkEhoD3xeOe-WtxXTePdeIgihq-Dri1ds/exec";

// CSVパーサ（Googleスプレッドシート対応）
function parseCSV(text){
  text = text.replace(/^\uFEFF/,'').replace(/\r\n/g,'\n');
  const rows=[]; let cur='', row=[], inQuotes=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(inQuotes){
      if(c==='"' && n==='"'){cur+='"'; i++;}
      else if(c==='"'){inQuotes=false;}
      else{cur+=c;}
    }else{
      if(c==='"'){inQuotes=true;}
      else if(c===','){row.push(cur); cur='';}
      else if(c==='\n'){row.push(cur); rows.push(row); row=[]; cur='';}
      else{cur+=c;}
    }
  }
  row.push(cur); rows.push(row);
  const header=rows.shift().map(h=>(h||'').trim());
  return rows.filter(r=>r.some(v=>(v||'').trim()!==''))
             .map(r=>Object.fromEntries(header.map((h,i)=>[h, r[i]||''])));
}

// 正規化（ひらがな化＋記号除去）
function toHiragana(str){return str.replace(/[ァ-ン]/g,s=>String.fromCharCode(s.charCodeAt(0)-0x60));}
function normalize(s){
  return toHiragana((s||'').toLowerCase().normalize('NFKC')
    .replace(/[\s\u3000]/g,'')
    .replace(/[、。・，．,.!?！？:：;；~〜ー―\-_/\\()［\]【】<>＜＞]/g,''));
}

let deck=[], idx=0;

// CSVをlogに登録
document.getElementById('initBtn').onclick = async ()=>{
  const csvUrl = document.getElementById('csvUrl').value.trim();
  if(!csvUrl) return alert('CSVの公開URLを入力してください');
  const res = await fetch(csvUrl);
  const text = await res.text();
  const list = parseCSV(text).map(r=>({question:r.front, correctAnswer:r.back}));
  await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({action:'init', list:list})});
  alert('logに登録しました');
};

// logから読み込み
async function loadFromLog(mode){
  const res = await fetch(GAS_URL + '?mode=' + mode);
  deck = await res.json();
  if(!deck.length){alert('出題できる問題がありません'); return;}
  idx=0; render();
}

document.getElementById('loadUnanswered').onclick=()=>loadFromLog('unanswered');
document.getElementById('loadAll').onclick=()=>loadFromLog('all');

// 表示
function render(){
  if(!deck.length) return;
  const c=deck[idx];
  document.getElementById('frontText').textContent = c.front;
  document.getElementById('backText').textContent = c.back;
  document.getElementById('backText').style.display='none';
  document.getElementById('answerInput').value='';
  document.getElementById('message').textContent='';
  document.getElementById('flashcard').style.display='block';
}

// 判定
function checkAnswer(){
  const userRaw=document.getElementById('answerInput').value;
  const user=normalize(userRaw);
  const c=deck[idx];
  const corrects=String(c.back).split('|').map(x=>normalize(x));
  const ok=corrects.includes(user);
  document.getElementById('message').textContent = ok?'正解！':'不正解。正解は:'+c.back;
  document.getElementById('message').className = ok?'msg ok':'msg ng';
  // GAS更新
  fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({action:'update',question:c.front,correctAnswer:c.back,isCorrect:ok})});
}

document.getElementById('submitBtn').onclick=checkAnswer;
document.getElementById('revealBtn').onclick=()=>{const b=document.getElementById('backText'); b.style.display=b.style.display==='none'?'block':'none';};
document.getElementById('nextBtn').onclick=()=>{idx=(idx+1)%deck.length; render();};
document.getElementById('prevBtn').onclick=()=>{idx=(idx-1+deck.length)%deck.length; render();};

// ショートカット
window.addEventListener('keydown',(e)=>{
  if(e.key==='/' ){e.preventDefault();document.getElementById('revealBtn').click();}
  if(e.key.toLowerCase()==='n'){e.preventDefault();document.getElementById('nextBtn').click();}
  if(e.key.toLowerCase()==='p'){e.preventDefault();document.getElementById('prevBtn').click();}
  if(e.key==='Enter' && !e.shiftKey && !e.ctrlKey){e.preventDefault();checkAnswer();}
  if(e.key==='Enter' && (e.shiftKey||e.ctrlKey)){e.preventDefault();checkAnswer(); idx=(idx+1)%deck.length; render();}
});
</script>
</body>
</html>
