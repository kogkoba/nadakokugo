<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>国語フラッシュカード（記述式・スプレッドシート連携 + 学習ログ/GAS）</title>
<style>
  :root{--bg:#0b1020;--card:#121a33;--text:#e8eefc;--muted:#9fb2d8;--accent:#67b4ff;--ok:#3ddc97;--ng:#ff6b6b}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;background:#0b1020;color:var(--text);margin:0}
  .wrap{max-width:980px;margin:auto;padding:20px}
  h1{margin:8px 0 16px}
  .panel{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:14px}
  .grid{display:grid;gap:10px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  label{display:block;font-size:.9rem;color:var(--muted);margin-bottom:4px}
  input[type=text]{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0c1328;color:var(--text)}
  button{appearance:none;border:none;background:var(--accent);color:#001229;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,.18);color:var(--text)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .hint{color:var(--muted);font-size:.85rem}
  .flash{margin-top:14px;background:#121a33;border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:22px;min-height:220px;position:relative}
  .q{font-size:1.15rem;white-space:pre-line;line-height:1.7}
  .a{margin-top:10px;display:none;color:#cfe3ff}
  .badge{position:absolute;top:10px;right:12px;color:var(--muted);font-size:.85rem}
  .answer-box{display:flex;gap:8px;margin-top:12px}
  .answer-box input{flex:1}
  .msg{margin-top:8px;font-weight:700}
  .msg.ok{color:var(--ok)}
  .msg.ng{color:var(--ng)}
  .stats{display:flex;gap:12px;margin-top:8px;color:var(--muted);font-size:.9rem}
</style>
</head>
<body>
<div class="wrap">
  <h1>国語フラッシュカード（記述式・ランダム出題）</h1>

  <div class="panel grid">
    <div>
      <label>Googleスプレッドシートの <strong>CSV公開URL</strong></label>
      <input id="csvUrl" type="text" placeholder="https://docs.google.com/spreadsheets/d/【ID】/export?format=csv&id=【ID】&gid=【gid】" />
      <div class="hint">※ スプレッドシート → ファイル ＞ ウェブに公開 → 形式 <strong>CSV</strong> のURLを貼付け</div>
    </div>
    <div class="grid cols-2">
      <div>
        <label>問題の列名</label>
        <input id="frontKey" type="text" value="front" />
      </div>
      <div>
        <label>答えの列名（複数は | 区切り）</label>
        <input id="backKey" type="text" value="back" />
      </div>
    </div>
    <div class="grid cols-2">
      <div>
        <label>https://script.google.com/macros/s/AKfycbwqu6Re6FDYTJZmz1WY9Hcj05JA1UkvqLToGGjlnROmNcjzc5NqBy0WnpyBb9zjeE1x/exec</label>
        <input id="logUrl" type="text" placeholder="https://script.google.com/macros/s/…/exec" />
        <div class="hint">※ 設定すると解答ごとにログをスプレッドシートへ保存（正解/不正解・問題文など）</div>
      </div>
      <div>
        <label>記録オプション</label>
        <div class="row">
          <label class="row"><input id="logWrongOnly" type="checkbox" checked> 間違いのみ記録</label>
          <label class="row"><input id="logAll" type="checkbox"> 正解も記録</label>
        </div>
      </div>
    </div>
    <div class="row">
      <button id="loadBtn">CSVから読み込む</button>
      <button class="ghost" id="demoBtn">デモデータ</button>
      <button class="ghost" id="loadMissedBtn">ログ（GAS）から <strong>間違いのみ</strong> 読み込む</button>
      <button class="ghost" id="loadAllLogBtn">ログ（GAS）から <strong>全問題</strong> 読み込む</button>
      <label class="row" style="gap:6px"><input id="excludeSeen" type="checkbox"> 正解した問題をデッキから除外</label>
    </div>
    <div class="hint">ショートカット：Enter＝判定／<strong>Shift+Enter or Ctrl+Enter＝判定して次へ</strong>／N＝次へ／P＝前へ／←→＝移動／<code>/</code>＝答え表示</div>
  </div>

  <div class="row" style="margin-top:10px">
    <button id="prevBtn" class="ghost">◀ 前へ（P）</button>
    <button id="revealBtn">答えを表示（/）</button>
    <button id="nextBtn" class="ghost">次へ ▶（N）</button>
    <button id="shuffleBtn" class="ghost">ランダム並べ替え</button>
    <button id="resetBtn" class="ghost">進捗リセット</button>
    <button id="mistBtn" class="ghost">（この回の）間違いのみ</button>
    <button id="allBtn" class="ghost">全件に戻す</button>
  </div>

  <div id="flashcard" class="flash" style="display:none">
    <div class="badge" id="badge">0 / 0</div>
    <div class="q" id="frontText"></div>
    <div class="a" id="backText"></div>
    <div class="answer-box">
      <input id="answerInput" type="text" placeholder="答えを入力（例：だす）" autocomplete="off" />
      <button id="submitBtn">送信（Enter）</button>
    </div>
    <div class="msg" id="message"></div>
  </div>

  <div class="stats" id="stats" style="display:none">
    <div>総数: <span id="statTotal">0</span></div>
    <div>既出: <span id="statSeen">0</span></div>
    <div>正解: <span id="statOk">0</span></div>
    <div>不正解: <span id="statNg">0</span></div>
    <div>正答率: <span id="statRate">0%</span></div>
  </div>

  <details style="margin-top:14px">
    <summary>GAS（Google Apps Script）設定：記録＋再出題API</summary>
    <div class="hint">スプレッドシートの「拡張機能 → Apps Script」で下記を貼付け→ウェブアプリとしてデプロイ。<br>アクセス権：全員／実行ユーザー：自分。</div>
<pre class="hint" style="white-space:pre-wrap">/**
 * ログ保存 & 取り出しAPI
 * デプロイ: ウェブアプリ (doGet/doPost)
 * GET:  ?mode=missed  → 不正解のみ（重複除去）
 *       ?mode=all     → 全ログ（重複除去）
 * POST: {question,userAnswer,correctAnswer,isCorrect,index,total,source}
 */
function doPost(e){
  var data = JSON.parse(e.postData.contents||'{}');
  var ss = SpreadsheetApp.getActive();
  var sh = ss.getSheetByName('log') || ss.insertSheet('log');
  if(sh.getLastRow()===0){
    sh.appendRow(['timestamp','question','userAnswer','correctAnswer','isCorrect','deckIndex','total','source']);
  }
  sh.appendRow([new Date(), data.question, data.userAnswer, data.correctAnswer, data.isCorrect, data.index, data.total, data.source||'web']);
  return ContentService.createTextOutput('ok').setMimeType(ContentService.MimeType.TEXT);
}

function doGet(e){
  var mode = (e.parameter.mode||'').toLowerCase();
  var ss = SpreadsheetApp.getActive();
  var sh = ss.getSheetByName('log');
  var out = [];
  if(sh){
    var values = sh.getDataRange().getValues();
    var idxMap = {question:1, correct:3, isCorrect:4};
    var seen = {};
    for(var i=1;i<values.length;i++){
      var q = values[i][idxMap.question] || '';
      var a = values[i][idxMap.correct] || '';
      var ok = String(values[i][idxMap.isCorrect]).toLowerCase()==='true';
      if(mode==='missed' && ok) continue;
      var key = q+'\u0000'+a; // 重複除去
      if(!seen[key]){ seen[key]=1; out.push({front:q, back:a}); }
    }
  }
  return ContentService.createTextOutput(JSON.stringify(out)).setMimeType(ContentService.MimeType.JSON);
}
</pre>
  </details>
</div>

<script>
// ===== CSV（クォート対応の簡易パーサ） =====
function parseCSV(text){
  const rows=[]; let cur=''; let row=[]; let inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(inQ){
      if(c==='\"' && n==='\"'){ cur+='\"'; i++; }
      else if(c==='\"'){ inQ=false; }
      else cur+=c;
    } else {
      if(c==='\"'){ inQ=true; }
      else if(c===','){ row.push(cur); cur=''; }
      else if(c==='\\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
      else cur+=c;
    }
  }
  if(cur.length>0 || row.length>0){ row.push(cur); rows.push(row); }
  return rows;
}

// ===== 日本語判定の正規化 =====
function toHiragana(str){ return str.replace(/[ァ-ン]/g, s => String.fromCharCode(s.charCodeAt(0)-0x60)); }
function normalize(s){
  return toHiragana((s||'')
    .toLowerCase()
    .normalize('NFKC')
    .replace(/[\\s\\u3000]/g,'')
    .replace(/[、。・，．,.!?！？:：;；~〜ー―\\-_/\\\\\\(\\)\\[\\]【】<>＜＞]/g,'')
  );
}

// ===== 状態 =====
let cardsAll=[], deck=[], idx=0;
let frontKey='front', backKey='back';
let okCount=0, ngCount=0; const seen=new Set();

// ===== 要素 =====
const $=id=>document.getElementById(id);
const csvUrl=$('csvUrl'), loadBtn=$('loadBtn'), demoBtn=$('demoBtn');
const frontInp=$('frontKey'), backInp=$('backKey');
const flash=$('flashcard'), frontTxt=$('frontText'), backTxt=$('backText');
const badge=$('badge'), statBox=$('stats');
const statTotal=$('statTotal'), statSeen=$('statSeen'), statOk=$('statOk'), statNg=$('statNg'), statRate=$('statRate');
const prevBtn=$('prevBtn'), nextBtn=$('nextBtn'), revealBtn=$('revealBtn');
const shuffleBtn=$('shuffleBtn'), resetBtn=$('resetBtn'), mistBtn=$('mistBtn'), allBtn=$('allBtn');
const input=$('answerInput'), submitBtn=$('submitBtn'), msg=$('message');
const excludeSeen=$('excludeSeen');
const logUrl=$('logUrl'), logWrongOnly=$('logWrongOnly'), logAll=$('logAll');
const loadMissedBtn=$('loadMissedBtn'), loadAllLogBtn=$('loadAllLogBtn');

function updateStats(){
  statTotal.textContent=cardsAll.length; statSeen.textContent=seen.size; statOk.textContent=okCount; statNg.textContent=ngCount;
  const rate=(okCount+ngCount)? Math.round(okCount*100/(okCount+ngCount)) : 0; statRate.textContent=rate+'%';
}

function render(){
  if(deck.length===0){ flash.style.display='none'; statBox.style.display='none'; return; }
  const c=deck[idx];
  flash.style.display='block'; statBox.style.display='flex';
  frontTxt.textContent=c[frontKey]??'';
  const ans=c[backKey]??''; if(/<\\w+/.test(ans)) backTxt.innerHTML=ans; else backTxt.textContent=ans; backTxt.style.display='none';
  input.value=''; input.focus(); msg.textContent=''; msg.className='msg';
  badge.textContent=`${idx+1} / ${deck.length}`; updateStats();
}
function next(){ if(deck.length){ idx=(idx+1)%deck.length; render(); } }
function prev(){ if(deck.length){ idx=(idx-1+deck.length)%deck.length; render(); } }
function reveal(){ backTxt.style.display = backTxt.style.display==='none' ? 'block' : 'none'; }
function shuffle(){ for(let i=deck.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [deck[i],deck[j]]=[deck[j],deck[i]]; } idx=0; render(); }
function resetProgress(){ seen.clear(); okCount=0; ngCount=0; cardsAll.forEach(c=>{c.__ok=0;c.__ng=0;c.__seen=false}); render(); }
function onlyMist(){ const m=cardsAll.filter(c=>c.__ng>0); if(m.length){ deck=m.slice(); idx=0; render(); } else alert('不正解カードはまだありません'); }
function useAll(){ deck=cardsAll.slice(); idx=0; render(); }

// ===== ログ連携 =====
function logAttempt(payload){
  const url=(logUrl.value||'').trim(); if(!url) return;
  try{ fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}).catch(()=>{});}catch(_){ }
}
async function fetchLog(mode){
  const url=(logUrl.value||'').trim();
  if(!url){ alert('GASのウェブアプリURLを設定してください'); return []; }
  const resp = await fetch(url + (url.includes('?')?'&':'?') + 'mode=' + mode);
  if(!resp.ok){ alert('ログの取得に失敗しました: '+resp.status); return []; }
  const arr = await resp.json();
  return Array.isArray(arr)? arr : [];
}

// ===== 判定 =====
function checkAnswer(forceNext=false){
  const userRaw=input.value; const user=normalize(userRaw);
  const c=deck[idx]; const answersRaw=String(c[backKey]||'');
  const answers=answersRaw.split('|').map(x=>normalize(x));
  const correct=answers.some(a=>a.length>0 && a===user);
  c.__seen=true; seen.add(c);
  const payload={question:String(c[frontKey]||''),userAnswer:userRaw,correctAnswer:answersRaw.split('|')[0]||'',isCorrect:correct,index:idx+1,total:deck.length,source:'nadakokugo'};
  if((logWrongOnly.checked && !correct) || (logAll.checked)) logAttempt(payload);

  if(correct){
    c.__ok=(c.__ok||0)+1; okCount++; msg.textContent='正解！'; msg.className='msg ok';
    if(excludeSeen.checked){ deck.splice(idx,1); if(idx>=deck.length) idx=0; }
    setTimeout(()=>{ render(); }, 600);
  } else {
    c.__ng=(c.__ng||0)+1; ngCount++; msg.textContent='不正解。正解は：'+answersRaw.split('|')[0]; msg.className='msg ng';
    setTimeout(()=>{ render(); }, 900);
  }
  updateStats(); input.focus();
}

// ===== データ読み込み =====
async function loadCSV(url){
  const res=await fetch(url); if(!res.ok) throw new Error('CSVの取得に失敗: '+res.status);
  const text=await res.text(); const rows=parseCSV(text); if(rows.length<2) throw new Error('CSVにデータがありません');
  const header=rows[0].map(h=>h.trim());
  return rows.slice(1).filter(r=>r.some(v=>String(v).trim()!==''))
    .map(r=>Object.fromEntries(header.map((h,i)=>[h, r[i]??''])));
}
function setDeck(list){
  cardsAll=list.map(x=>({...x,__ok:0,__ng:0,__seen:false}));
  deck=cardsAll.slice(); shuffle();
}

// ===== イベント =====
document.getElementById('loadBtn').addEventListener('click', async()=>{
  try{
    frontKey=frontInp.value.trim()||'front'; backKey=backInp.value.trim()||'back';
    const url=csvUrl.value.trim(); if(!url) return alert('CSVの公開URLを入力してください');
    const data=await loadCSV(url);
    const filtered=data.filter(r=>r[frontKey]!==undefined && r[backKey]!==undefined);
    if(!filtered.length){ alert(`列名『${frontKey}』『${backKey}』が見つかりません。`); return; }
    setDeck(filtered);
  }catch(e){ alert(e.message); }
});
document.getElementById('demoBtn').addEventListener('click',()=>{
  frontKey=frontInp.value.trim()||'front'; backKey=backInp.value.trim()||'back';
  const demo=[
    {[frontKey]:'Q,つぎの□に共通して入る語をひらがなで書きなさい。\n舌を□\nあごを□\n口を□',[backKey]:'だす'},
    {[frontKey]:'「雨が上がる」の反対の意味の言葉をひらがなで書きなさい。',[backKey]:'ふる|降る'},
    {[frontKey]:'「草木が生える」の反対の意味の言葉をひらがなで書きなさい。',[backKey]:'かれる|枯れる'}
  ]; setDeck(demo);
});
document.getElementById('loadMissedBtn').addEventListener('click', async()=>{
  const arr = await fetchLog('missed');
  if(!arr.length){ alert('ログに不正解の記録が見つかりません。'); return; }
  setDeck(arr);
});
document.getElementById('loadAllLogBtn').addEventListener('click', async()=>{
  const arr = await fetchLog('all');
  if(!arr.length){ alert('ログの取得結果が空でした。'); return; }
  setDeck(arr);
});

prevBtn.addEventListener('click', next => {});
document.getElementById('prevBtn').addEventListener('click', ()=>{ const _=0; prev(); });
document.getElementById('nextBtn').addEventListener('click', ()=>{ const _=0; next(); });
document.getElementById('revealBtn').addEventListener('click', reveal);
document.getElementById('shuffleBtn').addEventListener('click', shuffle);
document.getElementById('resetBtn').addEventListener('click', resetProgress);
document.getElementById('mistBtn').addEventListener('click', onlyMist);
document.getElementById('allBtn').addEventListener('click', useAll);

document.getElementById('submitBtn').addEventListener('click', ()=>checkAnswer(false));
document.getElementById('answerInput').addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !e.shiftKey && !e.ctrlKey){ e.preventDefault(); checkAnswer(false); }
  if(e.key==='Enter' && (e.shiftKey||e.ctrlKey)){ e.preventDefault(); checkAnswer(true); }
});

// 入力中でも N/P/矢印 等で移動できるようにする
window.addEventListener('keydown', (e)=>{
  const ae=document.activeElement; const tag=(ae&&ae.tagName?ae.tagName.toLowerCase():''); const isTyping=tag==='input'||tag==='textarea'||(ae&&ae.isContentEditable);
  if(e.key==='/' ){ e.preventDefault(); reveal(); return; }
  if(e.key.toLowerCase()==='n' && !e.ctrlKey && !e.metaKey && !e.altKey){ if(isTyping) e.preventDefault(); next(); return; }
  if(e.key.toLowerCase()==='p' && !e.ctrlKey && !e.metaKey && !e.altKey){ if(isTyping) e.preventDefault(); prev(); return; }
  if(e.key==='ArrowRight'){ if(isTyping) e.preventDefault(); next(); return; }
  if(e.key==='ArrowLeft' ){ if(isTyping) e.preventDefault(); prev(); return; }
});
</script>
</body>
</html>
